name: ç”Ÿæˆè‡ªç”¨Apple TVç›´æ’­åˆ—è¡¨
 
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/*.yml'
      - 'ChannelList/*.list'
      - 'ChannelLogo/*/*.png'
  schedule:
    - cron: '0 5,17 * * *'  # æ¯å¤©å‡Œæ™¨1ç‚¹å’Œä¸‹åˆ13ç‚¹è¿è¡Œ 
  watch:
    types: [started]

env:
  TZ: Asia/Shanghai
  TELEGRAM_NOTIFICATION: true
  TELEGRAM_NOTIFICATION_CONTENT: <b>ğŸ“º AppleTVç›´æ’­é¢‘é“å·²æ›´æ–°ï¼</b>
  GROUP_NAME_CCTV: å¤®è§†é¢‘é“
  GROUP_NAME_SATT: å«è§†é¢‘é“
  GROUP_NAME_LOCAL: åœ°æ–¹é¢‘é“
  GROUP_NAME_DIG: æ•°å­—é¢‘é“
  GROUP_NAME_TIYU: ä½“è‚²é¢‘é“
  GROUP_NAME_HK: é¦™æ¸¯é¢‘é“
  GROUP_NAME_TW: å°æ¹¾é¢‘é“
  GROUP_NAME_JP: æ—¥æœ¬é¢‘é“
  GROUP_NAME_KR: éŸ©å›½é¢‘é“
  GROUP_NAME_EN: æ¬§ç¾éš¾é“
  # GROUP_NAME_MO: æ¾³é—¨é¢‘é“
  
  HKTW_ADD: false
  GET: true

jobs:
  GenerateList:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        ref: main
        fetch-depth: 0
        lfs: true
        

    - name: è·å–å½“å‰æ—¥æœŸ
      id: date
      run: echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
    

    
    - name: å›½å†…é¢‘é“
      if: env.GET == 'true'
      run : | 
       wget https://raw.githubusercontent.com/YueChan/Live/main/IPTV.m3u -O $source6.tmp
        # ç”ŸæˆV6ä¸´æ—¶æ–‡ä»¶
        awk '
        {
          gsub("\"å¤®è§†é¢‘é“","\"'"$GROUP_NAME_CCTV"'");
          if($0~/(tvg-name=\"CCTV|CCTV4K)/) {gsub(/group-title=\".*\"/, "group-title=\"'"$GROUP_NAME_CCTV"'\"")};
          gsub(/CCTV5.\"/,"CCTV5+ä½“è‚²èµ›äº‹\"");
          gsub("\"ç”µè§†æŒ‡å—","\"CCTVç”µè§†æŒ‡å—");
          gsub(/tvg-name=\"ä¸­å›½æ•™è‚²/,"tvg-name=\"CETV");
          if($0~/NEWTV/) {gsub(",",",NEWTV")};
          if($0~/tvg-name=\"(CCTV|CETV|CGTN)/) {gsub(/group-title=\".*\"/, "group-title=\"'"$GROUP_NAME_CCTV"'\"")};
          if($0~/group-title=\"å«è§†\"/ && $0!~/tvg-name=\".*å«è§†\".*tvg-logo/) {gsub("\"å«è§†","\"'"$GROUP_NAME_LOCAL"'")};
          if($0~/tvg-name=\".*å«è§†\".*tvg-logo/ || $0~/å‡¤å‡°/) {gsub(/group-title=\".*\"/, "group-title=\"'"$GROUP_NAME_SATT"'\"")};
          if($0!~/group-title=\"('"$GROUP_NAME_CCTV"'|'"$GROUP_NAME_SATT"'|'"$GROUP_NAME_LOCAL"')\"/) {gsub(/group-title=\".*\"/, "group-title=\"'"$GROUP_NAME_DIG"'\"")};
          print $0;
        }
        ' $source6.tmp>chinav6.tmp
        
        # ç”ŸæˆV6å¤®è§†å«è§†
        awk '
        {
          if($0~/\#EXTM3U/) {print $0};
          if($0~/group-title=\"'"$GROUP_NAME_CCTV"'\"/ || $0~/group-title=\"'"$GROUP_NAME_SATT"'\"/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            print $0;
          };
        }
        ' chinav6.tmp>Source/CCTV.m3u 
        
        # ç”ŸæˆV6åœ°æ–¹ç”µè§†å°
        awk '
        {
          if($0~/\#EXTM3U/) {print $0};
          if($0~/group-title=\"'"$GROUP_NAME_LOCAL"'\"/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            print $0;
          };
        }
        ' chinav6.tmp>IPTV/åœ°æ–¹é¢‘é“.m3u
       
        # ç”ŸæˆV6æ•°å­—é¢‘é“
        awk '
        { 
          if($0~/\#EXTM3U/) {print $0};
          if($0~/group-title=\"'"$GROUP_NAME_DIG"'\"/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            print $0;
          };
        }
        ' chinav6.tmp>Source/Dig.m3u
        
        awk -F'"' '
        {
          info=$0;
          name=$4;
          gsub(/group-title="æ•°å­—é¢‘é“.*"/, "group-title=\"'"$GROUP_NAME_DIG"'\"");
          if($0~/\#EXTM3U/) {print $0};
          if(info~/EXTINF/ && info!~/URLARU/) {
            churl="null";
            close("chinav6.tmp");
            cmd="awk '\''/"name"/{getline;print}'\'' chinav6.tmp";
            cmd | getline churl;
            if(churl!="null") {
              print info;
              print churl;
            };
            close(cmd);
          };
        }
        ' ChannelList/Dig.list>IPTV/æ•°å­—é¢‘é“.m3u


    - name: é‡æ–°æ’åºå›½å†…é¢‘é“å¹¶æ›´æ¢é€æ˜å›¾æ ‡
      run : |
        awk -F'"' '
        {
          info=$0;
          name=$4;
          gsub(/group-title=\"å¤®è§†.*\"/, "group-title=\"'"$GROUP_NAME_CCTV"'\"");
          gsub(/group-title=\"å«è§†.*\"/, "group-title=\"'"$GROUP_NAME_SATT"'\"");
          # åˆ°ç¬¬ä¸€ä¸ªç©ºè¡Œä¸ºæ­¢ if(length(info)==0) {exit};
          if(info~/\#EXIT/) {exit};
          if($0~/\#EXTM3U/) {print $0};
          if(info~/ç»¼åˆ/) {
            name="CCTV1\"";
            close("Source/CCTV.m3u");
            cmd="awk '\''/"name"/{getline;print}'\'' Source/CCTV.m3u";
            cmd | getline churl;
            print info;
            print churl;
            close(cmd);
            next;
          };
          if(info~/ä½“è‚²èµ›äº‹/) {
            name="ä½“è‚²èµ›äº‹";
            close("Source/CCTV.m3u");
            cmd="awk '\''/"name"/{getline;print}'\'' Source/CCTV.m3u";
            cmd | getline churl;
            print info;
            print churl;
            close(cmd);
            next;
          };
          if(info~/EXTINF/ && info!~/HaveURL/) {
            churl="null";
            close("Source/CCTV.m3u");
            cmd="awk '\''/"name"/{getline;print}'\'' Source/CCTV.m3u";
            cmd | getline churl;
            if(churl!="null") {
              print info;
              print churl;
            };
            close(cmd);
          };
        }
        ' ChannelList/China.list>IPTV/å¤®è§†å«è§†.m3u 
        





    - name: ä½“è‚²é¢‘é“
      if: env.GET == 'true'
      run: |
        wget https://ghproxy.com/https://raw.githubusercontent.com/youshandefeiyang/IPTV/main/main/IPTV.m3u -O feiyang.tmp
        wget https://raw.githubusercontent.com/YueChan/Live/main/IPTV.m3u -O source6.tmp
        wget https://ghproxy.com/https://raw.githubusercontent.com/YanG-1989/m3u/main/Gather.m3u -O yang.tmp
        cat source6.tmp feiyang.tmp yang.tmp > tiyu.tmp
        awk '
        {
          if($0~/\"online\"|\"timeout\"/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            gsub(/ \(.*p\)/,"");
            gsub(/\",/,"\" group-title=\"'"$GROUP_NAME_TIYU"'\",");
            print $0;
          };
        }
        ' tiyu.tmp>Source/Tiyu.m3u
        awk -F'"' '
        {
          info=$0;
          name=$4;
          gsub(/group-title="ä½“è‚²é¢‘é“.*"/, "group-title=\"'"$GROUP_NAME_TIYU"'\"");
          if($0~/\#EXTM3U/) {print $0};
          if(info~/EXTINF/ && info!~/URLARU/) {
            churl="null";
            close("tiyu.tmp");
            cmd="awk '\''/"name"/{getline;print}'\'' tiyu.tmp";
            cmd | getline churl;
            if(churl!="null") {
              print info;
              print churl;
            };
            close(cmd);
          };
        }
        ' ChannelList/Tiyu.list>IPTV/ä½“è‚²é¢‘é“.m3u

    - name: é¦™æ¸¯é¢‘é“
      if: env.GET == 'true'
      run : |
        wget https://raw.githubusercontent.com/lptv800/lptv800.github.io/master/IPTV.m3u -O hk.tmp
        awk '
        {
          if($0~/\"online\"|\"timeout\"/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            gsub(/ \(.*p\)/,"");
            gsub(/\",/,"\" group-title=\"'"$GROUP_NAME_HK"'\",");
            print $0;
          };
        }
        ' hk.tmp>Source/Hongkong.m3u
        awk -F'"' '
        {
          info=$0;
          name=$4;
          gsub(/group-title=\"æ¸¯å°é¢‘é“.*\"/, "group-title=\"'"$GROUP_NAME_HK"'\"");
          if($0~/\#EXTM3U/) {print $0};
          if(info~/EXTINF/ && info!~/URLARU/) {
            churl="null";
            close("hk.tmp");
            cmd="awk '\''/"name"/{getline;print}'\'' hk.tmp";
            cmd | getline churl;
            if(churl!="null") {
              print info;
              print churl;
            };
            close(cmd);
          };
        }
        ' ChannelList/Hongkong.list>IPTV/é¦™æ¸¯é¢‘é“.m3u
        
       
        
        
        
    - name: å°æ¹¾é¢‘é“
      if: env.GET == 'true'
      run : |
        wget https://raw.githubusercontent.com/iptv-org/iptv/master/streams/tw.m3u -O tw.tmp
        awk '
        {
          if($0~/\"online\"|\"timeout\"/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            gsub(/ \(.*p\)/,"");
            gsub(/\",/,"\" group-title=\"'"$GROUP_NAME_TW"'\",");
            print $0;
          };
        }
        ' tw.tmp>Source/Taiwan.m3u
        awk -F'"' '
        {
          info=$0;
          name=$4;
          gsub(/group-title=\"å°æ¹¾é¢‘é“.*\"/, "group-title=\"'"$GROUP_NAME_TW"'\"")
          if($0~/\#EXTM3U/) {print $0};
          if(info~/EXTINF/ && info!~/URLARU/) {
            churl="null";
            close("tw.tmp");
            cmd="awk '\''/"name"/{getline;print}'\'' tw.tmp";
            cmd | getline churl;
            if(churl!="null") {
              print info;
              print churl;
            };
            close(cmd);
          };
        }
        ' ChannelList/Taiwan.list>IPTV/å°æ¹¾é¢‘é“.m3u
        
        
        
        
    
    - name: æ—¥æœ¬é¢‘é“
                                                                                                 # æ£€æŸ¥ç¯å¢ƒå˜é‡ GET æ˜¯å¦è®¾ç½®ä¸º true
      if: env.GET == 'true'
      run : |
        wget https://raw.githubusercontent.com/iptv-org/iptv/master/streams/jp.m3u -O japan.tmp  # ä¸‹è½½æ—¥æœ¬é¢‘é“åˆ—è¡¨ï¼Œå¹¶å°†å…¶ä¿å­˜ä¸º japan.tmp
        awk '                                                                                    # å¯¹åˆ—è¡¨è¿›è¡Œå¤„ç†ï¼Œå°†é¢‘é“åç§°ã€URL å’Œåˆ†ç»„ä¿¡æ¯æå–å‡ºæ¥ï¼Œå¹¶ä¿å­˜ä¸º Source/Japan.m3u
        {
          if($0~/\"online\"|\"timeout\"/) {m=NR; n=NR+1};                                        # å¦‚æœå½“å‰è¡ŒåŒ…å« "online" æˆ– "timeout"ï¼Œåˆ™è®°å½•è¯¥è¡Œå·
          if(m<=NR && NR<=n) {                                                                   # å¦‚æœå½“å‰è¡Œåœ¨è®°å½•çš„è¡Œå·èŒƒå›´å†…ï¼Œåˆ™è¿›è¡Œå¤„ç†
            gsub(/ \(.*p\)/,"");                                                                 # åˆ é™¤æ‹¬å·ä¸­çš„åˆ†è¾¨ç‡ä¿¡æ¯ï¼Œå°† TBS æ›¿æ¢ä¸º TBS TVï¼Œæ·»åŠ åˆ†ç»„ä¿¡æ¯ï¼Œå¹¶è¾“å‡ºå½“å‰è¡Œ
            gsub(",TBS",",TBS TV");
            gsub(/\",/,"\" group-title=\"'"$GROUP_NAME_JP"'\",");
            print $0;
          };
        }
        ' japan.tmp>Source/Japan.m3u
        awk -F'"' '                                                                                # éå† ChannelList/Japan.list ä¸­çš„æ¯ä¸€è¡Œï¼Œæå–å‡ºé¢‘é“åç§°å’Œ URLï¼Œå¹¶ä¿å­˜ä¸º æ—¥æœ¬é¢‘é“.m3u
        {
          info=$0;                                                                                 # å°†å½“å‰è¡Œä¿å­˜åˆ°å˜é‡ info ä¸­
          name=$4;                                                                                 # æå–é¢‘é“åç§°ï¼Œå¹¶ä¿å­˜åˆ°å˜é‡ name ä¸­
          gsub(/group-title=\"æ—¥éŸ©é¢‘é“.*\"/, "group-title=\"'"$GROUP_NAME_JP"'\"");                 # å°†åˆ†ç»„ä¿¡æ¯ä¸­çš„ "æ—¥éŸ©é¢‘é“" æ›¿æ¢ä¸ºç¯å¢ƒå˜é‡ GROUP_NAME_JP ä¸­çš„å€¼ï¼Œå¹¶è¾“å‡º #EXTM3U è¡Œ
          if($0~/\#EXTM3U/) {print $0};                                                            # å¦‚æœå½“å‰è¡ŒåŒ…å« EXTINFï¼Œä½†ä¸åŒ…å« URLARUï¼Œåˆ™è¯´æ˜è¯¥è¡Œä¸ºé¢‘é“ä¿¡æ¯ï¼Œæå–å‡ºå¯¹åº” URLï¼Œå¹¶è¾“å‡ºåˆ°æ–‡ä»¶
          if(info~/EXTINF/ && info!~/URLARU/) {
            churl="null";                                                                          # åˆå§‹åŒ– churl å˜é‡
            close("japan.tmp");                                                             # å…³é—­ Source/Japan.m3u æ–‡ä»¶ï¼Œä»¥ä¾¿é‡æ–°æ‰“å¼€å¹¶è¯»å–å…¶ä¸­çš„è¡Œ
            cmd="awk '\''/"name"/{getline;print}'\'' japan.tmp";                            # æ„é€ å‘½ä»¤ï¼Œä» Source/Japan.m3u ä¸­æå–ä¸ name åŒ¹é…çš„è¡Œ
            cmd | getline churl;                                                                   # æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶å°†è¾“å‡ºä¿å­˜åˆ° churl ä¸­
            if(churl!="null") {
              print info;                                                                          # è¾“å‡ºå½“å‰è¡Œ
              print churl;                                                                         # è¾“å‡ºå¯¹åº”çš„ URL
            };
            close(cmd);                                                                            # å…³é—­å‘½ä»¤æ‰§è¡Œç»“æœ
          };
        }
        ' ChannelList/Japan.list>IPTV/æ—¥æœ¬é¢‘é“.m3u                                                       # è¾“å‡ºç»“æœåˆ° æ—¥æœ¬é¢‘é“.m3u æ–‡ä»¶
        
    - name: éŸ©å›½é¢‘é“
      if: env.GET == 'true'
      run : |
        wget https://raw.githubusercontent.com/iptv-org/iptv/master/streams/kr.m3u -O $korea.tmp -O korea.tmp
        awk '
        {
          if($0~/\"online\"|\"timeout\"/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            gsub(/ \(.*p\)/,"");
            gsub(/\",/,"\" group-title=\"'"$GROUP_NAME_KR"'\",");
            print $0;
          };
        }
        ' korea.tmp>Source/Korea.m3u
        awk -F'"' '
        {
          info=$0;
          name=$4;
          gsub(/group-title=\"æ—¥éŸ©é¢‘é“.*\"/, "group-title=\"'"$GROUP_NAME_KR"'\"");
          if($0~/\#EXTM3U/) {print $0};
          if(info~/EXTINF/ && info!~/URLARU/) {
            churl="null";
            close("korea.tmp");
            cmd="awk '\''/"name"/{getline;print}'\'' korea.tmp";
            cmd | getline churl;
            if(churl!="null") {
              print info;
              print churl;
            };
            close(cmd);
          };
        }
        ' ChannelList/Korea.list>IPTV/éŸ©å›½é¢‘é“.m3u


    - name: æ¬§ç¾é¢‘é“
      if: env.GET == 'true'
      run : |
        wget https://ghproxy.com/https://raw.githubusercontent.com/YanG-1989/m3u/main/Gather.m3u -O en.tmp
        awk '
        {
          if($0~/\"online\"|\"timeout\"/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            gsub(/ \(.*p\)/,"");
            gsub(/\",/,"\" group-title=\"'"$GROUP_NAME_EN"'\",");
            print $0;
          };
        }
        ' en.tmp>Source/English.m3u
        awk -F'"' '
        {
          info=$0;
          name=$4;
          gsub(/group-title=\"æ¬§ç¾.*\"/, "group-title=\"'"$GROUP_NAME_EN"'\"");
          if($0~/\#EXTM3U/) {print $0};
          if(info~/EXTINF/ && info!~/URLARU/) {
            churl="null";
            close("en.tmp");
            cmd="awk '\''/"name"/{getline;print}'\'' en.tmp";
            cmd | getline churl;
            if(churl!="null") {
              print info;
              print churl;
            };
            close(cmd);
          };
        }
        ' ChannelList/English.list>IPTV/æ¬§ç¾é¢‘é“.m3u
    

       
        
    - name: ç”ŸæˆAppleTVæ€»åˆ—è¡¨
      run : |
        cat IPTV/å¤®è§†å«è§†.m3u IPTV/æœ¬åœ°é¢‘é“.m3u IPTV/ä½“è‚²é¢‘é“.m3u IPTV/æ•°å­—é¢‘é“.m3u IPTV/é¦™æ¸¯é¢‘é“.m3u IPTV/å°æ¹¾é¢‘é“.m3u IPTV/æ—¥æœ¬é¢‘é“.m3u IPTV/éŸ©å›½é¢‘é“.m3u IPTV/æ¬§ç¾é¢‘é“.m3u IPTV/ç†ŠçŒ«é¢‘é“.m3u > IPTV_ipv6.m3u
    
    - name: åˆ é™¤ä¸´æ—¶æ–‡ä»¶
      run : |
        rm *.tmp
        ls
        
#   - name: åˆ é™¤ä¸´æ—¶æ–‡ä»¶
#      run : |
#        rm *.tmp
#        rm *tmp*
#        ls
        
        
    
    - name: åˆ¤æ–­æ˜¯å¦æœ‰å˜æ›´
      if: (!cancelled())
      id: status
      run: |
        STR1="nothing to commit, working tree clean"
        STR2="Changes not staged for commit"
        out=$(git status)
        if [[ "$(echo $out | grep "$STR1")" != "" ]]
        then
          echo "STATUS="nochange"" >> $GITHUB_OUTPUT
        fi
        if [[ "$(echo $out | grep "$STR2")" != "" ]]
        then
          echo "STATUS="change"" >> $GITHUB_OUTPUT
        fi
    
    - name: åˆå¹¶åˆ°ä»“åº“
      if: (!cancelled())
      run : |
        if [[ "${{steps.status.outputs.STATUS}}" == "change" ]]
        then
          git add .
          git commit -m  "Update:${{steps.date.outputs.DATE}}"
          git push origin main
        fi
    - name: ç§»é™¤workflowè¿è¡Œ
      if: (!cancelled())
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3
        

    - name: Telegramæ¨é€
      if: env.TELEGRAM_NOTIFICATION == 'true' && !cancelled()  
      run: |
        if [[ "${{steps.status.outputs.STATUS}}" == "change" ]]
        then
          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}&text=${{ env.TELEGRAM_NOTIFICATION_CONTENT }}&parse_mode=HTML"
          # curl -d "text=ğŸ“º AppleTVãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒ³ãƒãƒ«æ›´æ–°ã—ã¾ã—ãŸï¼" -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendmessage?chat_id=${{ secrets.TELEGRAM_CHAT_ID }}"
        fi
